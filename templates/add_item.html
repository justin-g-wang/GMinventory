{% extends "base.html" %}
{% block content %}

<div class="form-card">
    <h2>Add Item</h2>

    <form method="POST" id="add_form">

        {% if items %}
        <label>Load Existing Item
            <select id="existing_items">
                <option value="">Select Item</option>
                {% for item in items %}
                    <option value="{{ item[0] }}">{{ item[0] }} - {{ item[1] }}</option>
                {% endfor %}
            </select>
        </label>
        {% endif %}

        <label>Item Number
            <input type="text" name="item_number" id="item_number" onblur="fetchItemData()" oninput="debouncedFetch()" required>
        </label>

        <label>Name
            <input type="text" name="name" id="name" required>
        </label>

        <div class="inline-fields">
        <label>Quantity
            <input type="number" name="quantity" step="0.0001" required>
            </label>

            <label>Unit
                <select name="unit" id="unit" required>
                    <option value="">Select Unit</option>
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="lbs">lbs</option>
                    <option value="oz">oz</option>
                    <option value="cases">cases</option>
                    <option value="bottles">bottles</option>
                    <option value="bags">bags</option>
                </select>
            </label>
        </div>

        <label>Lot
            <div id="lot_select_container" style="display:none;">
                <select id="lot_select">
                    <option value="">Select Lot</option>
                </select>
            </div>
            <input type="text" name="lot" id="lot_input" required>
        </label>

       <label>Supplier
           <input type="text" name="supplier" id="supplier">
       </label>

        <label>Expiration Date
            <input type="date" name="exp" id="exp" required>
        </label>

        <button type="submit">Add</button>
    </form>
</div>

<script>
const itemNumberInput = document.getElementById("item_number");
const lotSelectContainer = document.getElementById("lot_select_container");
const lotSelect = document.getElementById("lot_select");
const lotInput = document.getElementById("lot_input");
const existingItemSelect = document.getElementById("existing_items");
let debounceTimer = null;

function showLotInput() {
    lotInput.style.display = "inline-block";
    lotInput.required = true;
}

function hideLotInput() {
    lotInput.style.display = "none";
    lotInput.required = false;
}

if (existingItemSelect) {
    existingItemSelect.addEventListener("change", () => {
        const selected = existingItemSelect.value;
        itemNumberInput.value = selected;
        if (selected) {
            fetchItemData();
        } else {
            resetFormFields(true);
        }
    });
}

function debouncedFetch() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fetchItemData, 300);
}

function fetchItemData() {
    const itemNumber = document.getElementById("item_number").value.trim();

    if (itemNumber === "") {
        resetFormFields();
        document.getElementById("name").value = "";
        return;
    }

    fetch(`/lookup_item/${itemNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.found) {
                document.getElementById("name").value = data.name;
                document.getElementById("unit").value = data.unit;
                document.getElementById("supplier").value = data.supplier;
                document.getElementById("exp").value = data.exp;
                loadLots(itemNumber);
            } else {
                resetFormFields(true);
            }
        });
}

function loadLots(itemNumber) {
    fetch(`/get_lots/${itemNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.lots && data.lots.length > 0) {
                lotSelect.innerHTML = `<option value=\"\">Select Lot</option>`;
                data.lots.forEach(lot => {
                    const option = document.createElement("option");
                    option.value = lot;
                    option.textContent = lot;
                    lotSelect.appendChild(option);
                });
                const newOption = document.createElement("option");
                newOption.value = "__new__";
                newOption.textContent = "Add New Lot";
                lotSelect.appendChild(newOption);
                lotSelectContainer.style.display = "block";
                lotSelect.required = true;
                hideLotInput();
                lotInput.value = "";
                lotSelect.value = "";
            } else {
                lotSelectContainer.style.display = "none";
                lotSelect.required = false;
                showLotInput();
                lotInput.value = "";
            }
        });
}

lotSelect.addEventListener("change", () => {
    const selected = lotSelect.value;
    if (selected === "__new__") {
        showLotInput();
        lotSelect.required = false;
        lotInput.value = "";
        lotInput.focus();
    } else if (selected) {
        lotInput.value = selected;
        hideLotInput();
        lotSelect.required = true;
    } else {
        lotInput.value = "";
        hideLotInput();
        lotSelect.required = true;
    }
});

function resetFormFields(clearItemSpecific = false) {
    if (clearItemSpecific) {
        document.getElementById("name").value = "";
        document.getElementById("unit").value = "";
        document.getElementById("supplier").value = "";
        document.getElementById("exp").value = "";
    }
    lotSelectContainer.style.display = "none";
    lotSelect.innerHTML = `<option value=\"\">Select Lot</option>`;
    lotSelect.required = false;
    showLotInput();
    lotInput.value = "";
}
</script>

{% endblock %}
