{% extends "base.html" %}
{% block content %}

<div class="form-card">
    <h2>Add Item</h2>

    <form method="POST" id="add_form">

        {% if items %}
        <label>Load Existing Item
            <select id="existing_items">
                <option value="">Select Item</option>
                {% for item in items %}
                    <option value="{{ item[0] }}">{{ item[0] }} - {{ item[1] }}</option>
                {% endfor %}
            </select>
        </label>
        {% endif %}

        <label>Item Number
            <input type="text" name="item_number" id="item_number" required>
        </label>

        <label>Name
            <input type="text" name="name" id="name" required>
        </label>

        <div class="inline-fields">
        <label>Quantity
            <input type="number" name="quantity" step="0.0001" required>
            </label>

            <label>Unit
                <select name="unit" id="unit" required>
                    <option value="">Select Unit</option>
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="lbs">lbs</option>
                    <option value="oz">oz</option>
                    <option value="cases">cases</option>
                    <option value="bottles">bottles</option>
                    <option value="bags">bags</option>
                </select>
            </label>
        </div>

        <label>Lot
            <div id="lot_select_container" style="display:none;">
                <select id="lot_select">
                    <option value="">Select Lot</option>
                </select>
            </div>
            <input type="text" name="lot" id="lot_input" required>
        </label>

       <label>Supplier
           <input type="text" name="supplier" id="supplier">
       </label>

        <label>Expiration Date
            <input type="date" name="exp" id="exp" required>
        </label>

        <button type="submit">Add</button>
    </form>
</div>

<script>
const inventoryData = {{ inventory_map|tojson }};
const itemNumberInput = document.getElementById("item_number");
const nameInput = document.getElementById("name");
const unitSelect = document.getElementById("unit");
const supplierInput = document.getElementById("supplier");
const expInput = document.getElementById("exp");
const lotSelectContainer = document.getElementById("lot_select_container");
const lotSelect = document.getElementById("lot_select");
const lotInput = document.getElementById("lot_input");
const existingItemSelect = document.getElementById("existing_items");

function showLotInput() {
    lotInput.style.display = "inline-block";
    lotInput.required = true;
}

function hideLotInput() {
    lotInput.style.display = "none";
    lotInput.required = false;
}

function populateLots(lots) {
    if (lots && lots.length > 0) {
        lotSelect.innerHTML = `<option value="">Select Lot</option>`;
        lots.forEach(lot => {
            const option = document.createElement("option");
            option.value = lot;
            option.textContent = lot;
            lotSelect.appendChild(option);
        });
        const newOption = document.createElement("option");
        newOption.value = "__new__";
        newOption.textContent = "Add New Lot";
        lotSelect.appendChild(newOption);
        lotSelectContainer.style.display = "block";
        lotSelect.required = true;
        hideLotInput();
        lotInput.value = "";
        lotSelect.value = "";
    } else {
        lotSelectContainer.style.display = "none";
        lotSelect.required = false;
        showLotInput();
        lotInput.value = "";
    }
}

function applyInventoryData(itemNumber) {
    const data = inventoryData[itemNumber];
    if (!data) {
        resetFormFields(true);
        return;
    }
    nameInput.value = data.name || "";
    if (data.unit) unitSelect.value = data.unit;
    supplierInput.value = data.supplier || "";
    if (data.exp) expInput.value = data.exp;
    populateLots(data.lots || []);
}

if (existingItemSelect) {
    existingItemSelect.addEventListener("change", () => {
        const selected = existingItemSelect.value;
        itemNumberInput.value = selected;
        if (selected) {
            applyInventoryData(selected);
        } else {
            resetFormFields(true);
        }
    });
}

itemNumberInput.addEventListener("input", () => {
    const value = itemNumberInput.value.trim();
    if (value) {
        applyInventoryData(value);
    } else {
        resetFormFields(true);
    }
});

lotSelect.addEventListener("change", () => {
    const selected = lotSelect.value;
    if (selected === "__new__") {
        showLotInput();
        lotSelect.required = false;
        lotInput.value = "";
        lotInput.focus();
    } else if (selected) {
        lotInput.value = selected;
        hideLotInput();
        lotSelect.required = true;
    } else {
        lotInput.value = "";
        hideLotInput();
        lotSelect.required = true;
    }
});

function resetFormFields(clearItemSpecific = false) {
    if (clearItemSpecific) {
        nameInput.value = "";
        unitSelect.value = "";
        supplierInput.value = "";
        expInput.value = "";
    }
    lotSelectContainer.style.display = "none";
    lotSelect.innerHTML = `<option value="">Select Lot</option>`;
    lotSelect.required = false;
    showLotInput();
    lotInput.value = "";
}
</script>

{% endblock %}
