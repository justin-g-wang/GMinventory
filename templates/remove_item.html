{% extends "base.html" %}
{% block content %}

<div class="form-card">
    <h2>Remove Item From Inventory</h2>

    <form method="POST" id="remove_form">

        <label>Item Number
            <input list="item_number_list" name="item_number" id="item_number" placeholder="Type or select item number" required>
            <datalist id="item_number_list">
                {% for item in items %}
                    <option value="{{ item[0] }}">{{ item[0] }} - {{ item[1] }}</option>
                {% endfor %}
            </datalist>
        </label>

        <p id="item_name_display" class="form-note"></p>

        <label>Lot Number
            <select name="lot" id="lot" onchange="loadLotInfo()" required>
                <option value="">Select Lot</option>
            </select>
        </label>

        <p id="available" class="form-note"><i>Select a lot to view availability...</i></p>

        <div class="inline-fields">
            <label>Quantity to Remove
                <input type="number" name="quantity" id="qty_to_remove" required>
            </label>
            <label>Unit
                <input type="text" id="unit_display" class="unit-readonly" readonly placeholder="Unit">
            </label>
        </div>

        <button type="submit">Remove</button>
    </form>
</div>

<script>
const inventoryData = {{ inventory_map|tojson }};
let currentAvailability = null;
const unitDisplay = document.getElementById("unit_display");
const itemInput = document.getElementById("item_number");

function handleItemChange() {
    const value = itemInput.value.trim();
    const entry = inventoryData[value];
    const nameDisplay = document.getElementById("item_name_display");

    nameDisplay.textContent = entry && entry.name ? `Item Name: ${entry.name}` : "";

    loadLots();
}

function loadLots() {
    const item = itemInput.value.trim();
    const lotMenu = document.getElementById("lot");
    const entry = inventoryData[item];

    lotMenu.innerHTML = '<option value="">Select Lot</option>';
    if (!item || !entry) {
        document.getElementById("available").innerHTML = '<i>Select a lot to view availability...</i>';
        currentAvailability = null;
        unitDisplay.value = "";
        return;
    }

    Object.keys(entry.lots).forEach(lot => {
        lotMenu.innerHTML += `<option value="${lot}">${lot}</option>`;
    });
    unitDisplay.value = "";
    currentAvailability = null;
}

function loadLotInfo() {
    const item = itemInput.value.trim();
    const lot = document.getElementById("lot").value;
    const entry = inventoryData[item];

    if (!item || !lot || !entry || !entry.lots[lot]) {
        unitDisplay.value = "";
        document.getElementById("available").innerHTML = '<i>Select a lot to view availability...</i>';
        currentAvailability = null;
        return;
    }

    const data = entry.lots[lot];
    document.getElementById("available").innerHTML =
        `Available: <b>${data.quantity} ${data.unit || ''}</b>`;
    currentAvailability = data;
    unitDisplay.value = data.unit || "";
}

document.getElementById("remove_form").addEventListener("submit", (event) => {
    if (!currentAvailability) return;
    const qty = parseInt(document.getElementById("qty_to_remove").value, 10);
    if (isNaN(qty)) return;
    if (qty > currentAvailability.quantity) {
        event.preventDefault();
        alert(`Cannot remove ${qty} ${currentAvailability.unit}. Only ${currentAvailability.quantity} ${currentAvailability.unit} available.`);
    }
});
itemInput.addEventListener("input", handleItemChange);

</script>

{% endblock %}
