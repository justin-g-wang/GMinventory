{% extends "base.html" %}
{% block content %}

<h2>Remove Item From Inventory</h2>

<form method="POST" id="remove_form">

    <label>Item Number:
        <select name="item_number" id="item_number" onchange="handleItemChange()" required>
            <option value="">Select Item Number</option>
            {% for item in items %}
                <option value="{{ item[0] }}" data-name="{{ item[1] }}">{{ item[0] }} - {{ item[1] }}</option>
            {% endfor %}
        </select>
    </label><br>

    <p id="item_name_display"></p>

    <label>Lot Number:
        <select name="lot" id="lot" onchange="loadLotInfo()" required>
            <option value="">Select Lot</option>
        </select>
    </label><br>

    <p id="available"><i>Select a lot to view availability...</i></p>

    <label>Quantity to Remove:
        <input type="number" name="quantity" id="qty_to_remove" required>
    </label><br>

    <button type="submit">Remove</button>
</form>

<script>
let currentAvailability = null;

function handleItemChange() {
    const select = document.getElementById("item_number");
    const selectedOption = select.options[select.selectedIndex];
    const nameDisplay = document.getElementById("item_name_display");

    if (selectedOption && selectedOption.dataset.name) {
        nameDisplay.textContent = `Item Name: ${selectedOption.dataset.name}`;
    } else {
        nameDisplay.textContent = "";
    }

    loadLots();
}

function loadLots() {
    const item = document.getElementById("item_number").value;
    const lotMenu = document.getElementById("lot");
    if (!item) {
        lotMenu.innerHTML = '<option value="">Select Lot</option>';
        document.getElementById("available").innerHTML = '<i>Select a lot to view availability...</i>';
        currentAvailability = null;
        return;
    }

    fetch(`/get_lots/${item}`)
    .then(res => res.json())
    .then(data => {
        lotMenu.innerHTML = '<option value="">Select Lot</option>';

        data.lots.forEach(l => {
            lotMenu.innerHTML += `<option value="${l}">${l}</option>`;
        });
    });
}

function loadLotInfo() {
    const item = document.getElementById("item_number").value;
    const lot = document.getElementById("lot").value;

    if (!item || !lot) return;

    fetch(`/lot_info/${item}/${lot}`)
    .then(res => res.json())
    .then(data => {
        if (data.found) {
            document.getElementById("available").innerHTML =
                `Available: <b>${data.quantity} ${data.unit}</b>`;
            currentAvailability = data;
        }
    });
}

document.getElementById("remove_form").addEventListener("submit", (event) => {
    if (!currentAvailability) return;
    const qty = parseInt(document.getElementById("qty_to_remove").value, 10);
    if (isNaN(qty)) return;
    if (qty > currentAvailability.quantity) {
        event.preventDefault();
        alert(`Cannot remove ${qty} ${currentAvailability.unit}. Only ${currentAvailability.quantity} ${currentAvailability.unit} available.`);
    }
});

</script>

{% endblock %}
